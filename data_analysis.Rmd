---
title: "R Notebook"
output: html_notebook
---

## Загрузка подготовленного датасета
```{r dataset load}
dataset <- read.csv('const_dataset.csv', sep=',')
dataset <- subset(dataset, minority_population_pct!=0)
dataset <- subset(dataset, tract_to_msamd_income_pct!=0)
```

## Статистика отношения заполненных/незаполненных данных, полученная в процессе чистки на ЯП Python (Notebook приложен)
![](fill_rate.jpg)

## Определение факторов датафрейма
```{r defining factors}
dataset$loan_type = factor(dataset$loan_type)
dataset$loan_purpose = factor(dataset$loan_purpose)
dataset$preapproval = factor(dataset$preapproval)
dataset$action_type = factor(dataset$action_type)
dataset$county_name=factor(dataset$county_name)
dataset$lien_status = factor(dataset$lien_status)
dataset$applicant_ethnicity = factor(dataset$applicant_ethnicity)
dataset$applicant_race_1 = factor(dataset$applicant_race_1)
dataset$applicant_sex = factor(dataset$applicant_sex)
dataset$state_name = factor(dataset$state_name)
```

## Исследование исходных данных
### Исследование зависимости спреда ставки от состояния заявки
Ипотечные заявки без указанного спреда ставки являются единственным видом заявок, прошедшие рассмотрение и по которым вынесен вердикт отличный от выдачи кредита. Кредиты со спредом, отличным от 0, находятся в исключительно "выданном" состоянии.
```{r action_type vs. rate_spread}
with(dataset, head(table(rate_spread, action_type), n = 15))
```
### Исследование зависимости отношения статуса предварительного одобрения и расы
Отношение Запрошенных/отклоненных заявок:

Раса | Запрошенных/отклоненных заявок
------------- | -------------
AmerInd.AlaskaNat | 0,025510204
Asian | 0,031478915
Black.AfroAmer | 0,041154995
Hawaiian.PacificIs | 0,037037037
No Info | 0,01891855
Not Applicable | 0,012048193
White | 0,028921694

Афроамериканцы реже получают предварительный отказ чем другие расы
```{r race vs preapproval}
with(dataset, table(applicant_race_1, preapproval))
```

Предположим, что средний доход является значимым фактором:
```{r tract_median_income}
tract_median_income = with(dataset, hud_median_family_income*(tract_to_msamd_income_pct/100))
dataset$tract_median_income_ink = round(tract_median_income/1000) 
```

```{r tract_median_income density plot}
den = density(log10(dataset$tract_median_income_ink))
plot(den, main = "График плотности среднего дохода")
```

```{r}
plot(density(log10(dataset$loan_amount_ink)), main = "Плотность суммы кредита", ylab = "Плотность")
```

```{r}
with(dataset,  {
 homepurchase = density(log10(subset(loan_amount_ink, loan_purpose=="Home purchase")))
 homeimprovement = density(log10(subset(loan_amount_ink, loan_purpose=="Home improvement")))
 refinance = density(log10(subset(loan_amount_ink, loan_purpose=="Refinancing")))
 
 plot(homepurchase, col="red", main="Классификация кредитов" , xlab = "Log(Сумма кредита)", ylab = "Плотность")
 lines(homeimprovement, col="blue")
 lines(refinance, col="green")
})
```

```{r}
plot(density(log10(dataset$loan_amount_ink)), main = "Плотность суммы кредита")
abline(v=440)
abline(v=400)
```

```{r}
# what is that spike at about 400K? Smooth up until then. That and past it is one or two other populations.
# Let's try a model for below that spike. In principle, we can develop a separate model beyond that spike
# (Note, they might also want to eliminate some of the very small loans that trail out on the right.
# I didn't do that here, but it would be a fair thing for them to do)
filter = dataset$loan_amount_ink <= 400
# ggplot(dataset[filter,], aes(x=Loan_Amount_inK, colour=loanpurpose)) + geom_density(adjust=0.5) + scale_x_log10()

plot(density(log10(dataset$loan_amount_ink)), main="Loan Amount Density")
abline(v=440)
abline(v=400)
```


```{r}





sum(filter)/length(filter) # we lose about 4% of the loan data.

dataset = dataset[filter,]

plot(density(dataset$loan_amount_ink), main="Loan Amount Density <= 400 thousand", xlab="Income in thousands")
#
# till here
# subset to only originated and denied: reasoning -- borrowers will take most advantageous loan they can.
# This might be part of the starting scenario
#

filter = with(dataset, action_type %in% c("Originated", "Denied"))
dataset = dataset[filter,]
dataset$approved = dataset$action_type=="Originated"
table(dataset$approved)/dim(dataset)[1]
```

